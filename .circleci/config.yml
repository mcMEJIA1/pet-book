job_defaults: &job_defaults
  docker:
  - image: circleci/node:latest-browsers
    environment:
      CHROME_BIN: /usr/bin/google-chrome
  working_directory: ~/pet-book

jobs:
  static-code-scan:
    <<: *job_defaults
    steps:
      - checkout
      - sonarcloud/scan
  
  test:
    <<: *job_defaults
    steps:
      - checkout
      - run: 
          name: Install local dependencies
          command: npm install
      - run:
          name: test application
          command: npm run test-ci
  
  build:
    <<: *job_defaults
    steps:
      - checkout
      - run: 
          name: Install local dependencies
          command: npm install
      - run:
          name: build
          command: npm run build --prod

  deploy:
    <<: *job_defaults
    steps:
      - checkout
      - aws-s3/sync:
        arguments: |
          --acl public-read \
          --cache-control "max-age=86400"
        aws-acces-key-id: AWS_ACCESS_KEY_ID
        aws-region: AWS_DEFAULT_REGION
        aws-secret-acces-key: AWS_SECRET_ACCESS_KEY
        from: 
orbs:
  sonarcloud: sonarsource/sonarcloud@1.0.0
  aws-s3: circleci/aws-s3@2.0.0

version: 2.1
workflows:
  main:
    jobs:
      - build
      - test
      - static-code-scan:
        requires:
          - build
        context: sonarCloud