job_defaults: &job_defaults
  docker:
  - image: 'node:latest'
    environment:
      CHROME_BIN: /usr/bin/google-chrome
  working_directory: ~/pet-book

jobs:
  static-code-scan:
    <<: *job_defaults
    steps:
      - checkout
      - sonarcloud/scan
  
  test:
    <<: *job_defaults
    steps:
      - checkout
      - run: 
          name: Install local dependencies
          command: npm install
      - run:
          name: test application
          command: npm run test-ci

orbs:
  sonarcloud: sonarsource/sonarcloud@1.0.0
version: 2.1
workflows:
  main:
    jobs:
      - static-code-scan:
          context: sonarCloud
      - test:
          requires:
            - static-code-scan